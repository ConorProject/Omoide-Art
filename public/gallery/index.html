<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Omoide Art Gallery</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .gallery-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .gallery-title {
            font-family: 'Noto Serif JP', serif;
            font-size: clamp(2rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .gallery-subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 24px;
        }

        .expiry-notice {
            background: linear-gradient(135deg, #FFF8F0 0%, #FFF2E6 100%);
            border: 1px solid #F0C674;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 40px;
            text-align: center;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .memory-details {
            background: white;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .memory-location {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 16px;
        }

        .memory-focus {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .memory-detail {
            color: var(--text-light);
            margin-bottom: 16px;
            line-height: 1.7;
        }

        .memory-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .memory-tag {
            background: var(--hover-bg);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
            margin-bottom: 60px;
        }

        .image-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        }

        .image-container {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
        }

        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .image-card:hover .image-overlay {
            opacity: 1;
        }

        .view-fullsize {
            background: white;
            color: var(--text-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .view-fullsize:hover {
            background: var(--hover-bg);
        }

        .image-info {
            padding: 20px;
        }

        .image-number {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        .cta-section {
            background: linear-gradient(135deg, var(--accent-color) 0%, #A63D40 100%);
            border-radius: 20px;
            padding: 48px;
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .cta-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .cta-description {
            font-size: 1.1rem;
            margin-bottom: 32px;
            opacity: 0.95;
            line-height: 1.7;
        }

        .cta-button {
            background: white;
            color: var(--accent-color);
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
            text-decoration: none;
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .cta-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .new-gallery-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
        }

        .new-gallery-button:hover {
            background: white;
            color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .collection-button {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.7);
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
        }

        .collection-button:hover {
            background: rgba(255, 255, 255, 0.9);
            color: var(--accent-color);
            border-color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            color: var(--text-light);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .back-link {
            display: inline-block;
            margin-top: 32px;
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .progress-section {
            background: linear-gradient(135deg, #FFF8F0 0%, #FFF2E6 100%);
            border: 1px solid #F0C674;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 40px;
            text-align: center;
        }

        .progress-header h3 {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .progress-header p {
            color: var(--text-light);
            margin-bottom: 20px;
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            height: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--accent-color) 0%, #A63D40 100%);
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .generating-placeholder,
        .pending-placeholder,
        .error-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            background: var(--hover-bg);
            border-radius: 12px;
        }

        .generating-placeholder p,
        .pending-placeholder p,
        .error-placeholder p {
            margin-top: 16px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .retry-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 12px;
            transition: var(--transition);
        }

        .retry-button:hover {
            background: #A63D40;
        }

        .image-status {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        .image-card.newly-completed {
            animation: imageComplete 1s ease;
        }

        @keyframes imageComplete {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.02);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .image-card.generating {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 20px rgba(191, 61, 65, 0.2);
        }

        .image-card.failed {
            border: 2px solid #dc3545;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.1);
        }

        .image-card.pending {
            border: 2px solid #6c757d;
            opacity: 0.7;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .modal-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            align-items: center;
        }

        .modal-download {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }

        .modal-download:hover {
            background: #A63D40;
            transform: translateY(-2px);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: white;
            color: var(--text-primary);
        }

        .close-x {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-x:hover {
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .gallery-container {
                padding: 20px 16px;
            }

            .images-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .memory-details {
                padding: 24px;
            }

            .cta-section {
                padding: 32px 24px;
            }

            .progress-section {
                padding: 20px;
            }

            .modal-content {
                max-width: 95vw;
                max-height: 95vh;
            }

            .modal-controls {
                flex-direction: column;
                gap: 8px;
            }

            .close-x {
                top: 10px;
                right: 15px;
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="gallery-container">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading your Omoide Art gallery...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <h2 class="error-title">Gallery Not Found</h2>
            <p>This gallery may have expired or the link is incorrect.</p>
            <a href="/" class="back-link">← Create New Omoide Art</a>
        </div>

        <div id="gallery-content" style="display: none;">
            <div class="gallery-header">
                <h1 class="gallery-title">Your Omoide Art Gallery</h1>
                <p class="gallery-subtitle">Beautiful memories transformed into traditional Japanese shin-hanga art</p>
            </div>

            <div id="expiry-notice" class="expiry-notice">
                This gallery will expire in <strong id="time-remaining"></strong>.
                Purchase now to preserve your memories forever.
            </div>

            <div id="memory-details" class="memory-details">
                <!-- Memory details will be populated by JavaScript -->
            </div>

            <div id="images-grid" class="images-grid">
                <!-- Images will be populated by JavaScript -->
            </div>

            <div class="cta-section">
                <h2 class="cta-title">Download Your Digital Collection</h2>
                <p class="cta-description">
                    Get instant access to high-resolution, watermark-free versions of your artwork.
                    Perfect for digital collections, printing at home, or social media sharing.
                </p>
                <div class="cta-buttons">
                    <button class="cta-button" onclick="startDigitalDownload()">
                        Download High-Quality Images
                    </button>
                    <a href="/collection" class="collection-button">
                        View My Collection
                    </a>
                    <a href="#" id="new-gallery-button" class="new-gallery-button" onclick="createAnotherMemory()">
                        Create Another Memory
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <span class="close-x" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" class="modal-image" src="" alt="Full Size Artwork">
            <div class="modal-controls">
                <a id="modalDownload" href="" download class="modal-download">
                    Download Image
                </a>
                <button class="modal-close" onclick="closeModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get gallery ID from URL path
        function getGalleryId() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
        }

        // Format time remaining
        function formatTimeRemaining(milliseconds) {
            const days = Math.floor(milliseconds / (1000 * 60 * 60 * 24));
            const hours = Math.floor((milliseconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            if (days > 0) {
                return `${days} day${days !== 1 ? 's' : ''}`;
            } else if (hours > 0) {
                return `${hours} hour${hours !== 1 ? 's' : ''}`;
            } else {
                return 'less than 1 hour';
            }
        }

        // Polling intervals for individual request IDs
        let requestPollingIntervals = new Map();
        let isPolling = false;
        let currentGallery = null;

        // Load gallery data with live updates
        async function loadGallery() {
            const galleryId = getGalleryId();

            if (!galleryId) {
                showError('Invalid gallery URL');
                return;
            }

            try {
                const response = await fetch(`/api/gallery?id=${galleryId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                currentGallery = data.gallery;
                displayGallery(currentGallery);

                // Start polling for individual request IDs if gallery has pending images
                if (hasGeneratingImages(currentGallery) && !isPolling) {
                    startIndividualPolling();
                }

            } catch (error) {
                console.error('Failed to load gallery:', error);
                showError(error.message);
            }
        }

        // Check if gallery has images that are generating
        function hasGeneratingImages(gallery) {
            return gallery.images.some(image =>
                image.status === 'generating' && image.requestId
            );
        }

        // Start polling for individual request IDs
        function startIndividualPolling() {
            if (isPolling) return;

            isPolling = true;
            console.log('🔄 Starting individual request ID polling...');

            // Poll each image with a requestId that's generating
            currentGallery.images.forEach(image => {
                if (image.status === 'generating' && image.requestId) {
                    startRequestPolling(image.requestId, image.index);
                }
            });
        }

        // Start polling for a specific request ID
        function startRequestPolling(requestId, imageIndex) {
            if (requestPollingIntervals.has(requestId)) return;

            console.log(`🔍 Starting polling for request ${requestId} (image ${imageIndex})`);

            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check-status?requestId=${requestId}`);
                    const data = await response.json();

                    if (data.success) {
                        await handleRequestStatusUpdate(requestId, imageIndex, data);
                    }
                } catch (error) {
                    console.error(`Polling error for request ${requestId}:`, error);
                }
            }, 5000); // Poll every 5 seconds

            requestPollingIntervals.set(requestId, interval);
        }

        // Handle status update for individual request
        async function handleRequestStatusUpdate(requestId, imageIndex, statusData) {
            const status = statusData.status || statusData.data?.status;

            console.log(`📊 Request ${requestId} status: ${status}`);

            if (status === 'completed' || status === 'succeeded') {
                // Stop polling for this request
                stopRequestPolling(requestId);

                // Extract image URLs from response
                const imageUrl = extractImageUrl(statusData.data);

                if (imageUrl) {
                    // Update gallery metadata with completed image
                    await updateGalleryImage(imageIndex, requestId, 'completed', imageUrl);

                    // Update UI
                    updateImageCard(imageIndex, 'completed', imageUrl);

                    console.log(`✅ Image ${imageIndex} completed: ${imageUrl}`);
                } else {
                    console.error(`❌ Image ${imageIndex} completed but no URL found`);
                    await updateGalleryImage(imageIndex, requestId, 'failed');
                    updateImageCard(imageIndex, 'failed');
                }
            } else if (status === 'failed' || status === 'error') {
                // Stop polling and mark as failed
                stopRequestPolling(requestId);
                await updateGalleryImage(imageIndex, requestId, 'failed');
                updateImageCard(imageIndex, 'failed');

                console.log(`❌ Image ${imageIndex} failed`);
            }

            // Check if all images are done
            checkGalleryCompletion();
        }

        // Extract image URL from Wavespeed response
        function extractImageUrl(data) {
            // Handle different response formats from Wavespeed API
            if (data.outputs && data.outputs[0]) {
                return data.outputs[0]; // Wavespeed returns direct URLs in outputs array
            }
            if (data.output && data.output.url) {
                return data.output.url;
            }
            if (data.url) {
                return data.url;
            }
            return null;
        }

        // Update gallery metadata via API
        async function updateGalleryImage(imageIndex, requestId, status, imageUrl = null) {
            try {
                const galleryId = getGalleryId();
                const updateData = {
                    galleryId,
                    imageIndex,
                    requestId,
                    status
                };

                if (imageUrl) {
                    updateData.webUrl = imageUrl;
                    updateData.printUrl = imageUrl;
                }

                const response = await fetch('/api/update-gallery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('Failed to update gallery metadata:', result.message);
                }
            } catch (error) {
                console.error('Error updating gallery metadata:', error);
            }
        }

        // Stop polling for a specific request ID
        function stopRequestPolling(requestId) {
            const interval = requestPollingIntervals.get(requestId);
            if (interval) {
                clearInterval(interval);
                requestPollingIntervals.delete(requestId);
                console.log(`🛑 Stopped polling for request ${requestId}`);
            }
        }

        // Check if gallery is complete and stop all polling
        function checkGalleryCompletion() {
            if (requestPollingIntervals.size === 0) {
                isPolling = false;
                console.log('✅ All images completed - polling stopped');
            }
        }

        // Stop all polling
        function stopPolling() {
            // Stop all individual request polling
            requestPollingIntervals.forEach((interval, requestId) => {
                clearInterval(interval);
                console.log(`🛑 Stopped polling for request ${requestId}`);
            });
            requestPollingIntervals.clear();
            isPolling = false;
            console.log('✅ All polling stopped');
        }

        // Update individual image card in UI
        function updateImageCard(imageIndex, status, imageUrl = null) {
            const card = document.querySelector(`[data-index="${imageIndex}"]`);
            if (!card) return;

            if (status === 'completed' && imageUrl) {
                card.innerHTML = `
                    <div class="image-container">
                        <img src="${imageUrl}" alt="Omoide Art ${imageIndex}" class="gallery-image" loading="lazy">
                        <div class="image-overlay">
                            <button class="view-fullsize" onclick="viewFullsize('${imageUrl}')">
                                View Full Size
                            </button>
                        </div>
                    </div>
                    <div class="image-info">
                        <div class="image-number">Artwork ${imageIndex}</div>
                        <div class="image-status">✅ Complete</div>
                    </div>
                `;
                card.className = 'image-card completed newly-completed';

                // Remove animation class after 1 second
                setTimeout(() => card.classList.remove('newly-completed'), 1000);

            } else if (status === 'failed') {
                card.innerHTML = `
                    <div class="image-container">
                        <div class="error-placeholder">
                            <p>❌ Generation failed</p>
                            <button class="retry-button" onclick="retryImage(${imageIndex})">
                                Retry
                            </button>
                        </div>
                    </div>
                    <div class="image-info">
                        <div class="image-number">Artwork ${imageIndex}</div>
                        <div class="image-status">Failed</div>
                    </div>
                `;
                card.className = 'image-card failed';
            }
        }

        // Display gallery content with progressive loading support
        function displayGallery(gallery) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('gallery-content').style.display = 'block';

            // Update time remaining
            const timeRemaining = formatTimeRemaining(gallery.timeRemaining);
            document.getElementById('time-remaining').textContent = timeRemaining;

            // Populate memory details
            const memoryDetails = document.getElementById('memory-details');
            const { userInputs } = gallery;

            memoryDetails.innerHTML = `
                <div class="memory-location">${userInputs.location}, Japan</div>
                <div class="memory-focus">${userInputs.focus}</div>
                <div class="memory-detail">${userInputs.detail}</div>
                <div class="memory-tags">
                    <span class="memory-tag">${userInputs.atmosphere}</span>
                    ${userInputs.feelings.map(feeling => `<span class="memory-tag">${feeling}</span>`).join('')}
                </div>
            `;

            // Update progress indicator based on status
            updateProgressIndicator(gallery);

            // Populate images grid
            updateImagesGrid(gallery);
        }

        // Update progress indicator
        function updateProgressIndicator(gallery) {
            const progressSection = document.getElementById('progress-section') || createProgressSection();

            if (gallery.status === 'generating') {
                const { completed, total, generating } = gallery.progress;
                progressSection.innerHTML = `
                    <div class="progress-header">
                        <h3>Creating Your Omoide Art...</h3>
                        <p>Transforming your memories into beautiful shin-hanga artwork</p>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(completed / total) * 100}%"></div>
                    </div>
                    <div class="progress-text">
                        ${completed} of ${total} artworks completed
                        ${generating > 0 ? ` • ${generating} currently generating` : ''}
                    </div>
                `;
                progressSection.style.display = 'block';
            } else if (gallery.status === 'partial') {
                const { completed, total, failed } = gallery.progress;
                progressSection.innerHTML = `
                    <div class="progress-header">
                        <h3>Gallery Partially Complete</h3>
                        <p>${completed} of ${total} artworks successfully created</p>
                    </div>
                    <div class="progress-text">
                        ${failed} artwork${failed !== 1 ? 's' : ''} could not be generated due to technical issues
                    </div>
                `;
                progressSection.style.display = 'block';
            } else {
                progressSection.style.display = 'none';
            }
        }

        // Create progress section if it doesn't exist
        function createProgressSection() {
            const progressSection = document.createElement('div');
            progressSection.id = 'progress-section';
            progressSection.className = 'progress-section';

            const memoryDetails = document.getElementById('memory-details');
            memoryDetails.parentNode.insertBefore(progressSection, memoryDetails.nextSibling);

            return progressSection;
        }

        // Update images grid with placeholders and completed images
        function updateImagesGrid(gallery) {
            const imagesGrid = document.getElementById('images-grid');

            imagesGrid.innerHTML = gallery.images.map((image, index) => {
                if (image.status === 'completed' && image.webUrl) {
                    return `
                        <div class="image-card completed" data-index="${image.index}">
                            <div class="image-container">
                                <img src="${image.webUrl}" alt="Omoide Art ${image.index}" class="gallery-image" loading="lazy">
                                <div class="image-overlay">
                                    <button class="view-fullsize" onclick="viewFullsize('${image.webUrl}')">
                                        View Full Size
                                    </button>
                                </div>
                            </div>
                            <div class="image-info">
                                <div class="image-number">Artwork ${image.index}</div>
                                <div class="image-status">✅ Complete</div>
                            </div>
                        </div>
                    `;
                } else if (image.status === 'generating') {
                    return `
                        <div class="image-card generating" data-index="${image.index}">
                            <div class="image-container">
                                <div class="generating-placeholder">
                                    <div class="loading-spinner"></div>
                                    <p>Creating artwork...</p>
                                </div>
                            </div>
                            <div class="image-info">
                                <div class="image-number">Artwork ${image.index}</div>
                                <div class="image-status">🎨 Generating</div>
                            </div>
                        </div>
                    `;
                } else if (image.status === 'failed') {
                    return `
                        <div class="image-card failed" data-index="${image.index}">
                            <div class="image-container">
                                <div class="error-placeholder">
                                    <p>❌ Generation failed</p>
                                    <button class="retry-button" onclick="retryImage(${image.index})">
                                        Retry
                                    </button>
                                </div>
                            </div>
                            <div class="image-info">
                                <div class="image-number">Artwork ${image.index}</div>
                                <div class="image-status">Failed</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="image-card pending" data-index="${image.index}">
                            <div class="image-container">
                                <div class="pending-placeholder">
                                    <p>⏳ In queue</p>
                                </div>
                            </div>
                            <div class="image-info">
                                <div class="image-number">Artwork ${image.index}</div>
                                <div class="image-status">Pending</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Update gallery progress (legacy fallback)
        function updateGalleryProgress(gallery) {
            console.log(`🔄 Gallery update: ${gallery.progress.completed}/4 completed`);

            // Update current gallery reference
            currentGallery = gallery;

            updateProgressIndicator(gallery);
            updateImagesGrid(gallery);

            // Start individual polling for new request IDs
            if (hasGeneratingImages(gallery) && !isPolling) {
                startIndividualPolling();
            }
        }

        // Show error state
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            if (message) {
                document.querySelector('.error p').textContent = message;
            }
        }

        // View fullsize image in modal
        function viewFullsize(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalDownload = document.getElementById('modalDownload');

            modalImage.src = imageUrl;
            modalDownload.href = imageUrl;
            modal.style.display = 'block';

            // Close modal when clicking outside the image
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            };
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // Create another memory with pre-populated data
        function createAnotherMemory() {
            if (!currentGallery || !currentGallery.userInputs) {
                window.location.href = '/';
                return;
            }

            const { userInputs } = currentGallery;
            const params = new URLSearchParams();

            // Add all user inputs as URL parameters
            params.set('location', userInputs.location || '');
            params.set('atmosphere', userInputs.atmosphere || '');
            params.set('focus', userInputs.focus || '');
            params.set('detail', userInputs.detail || '');
            params.set('aspectRatio', userInputs.aspectRatio || '1:1');
            params.set('season', userInputs.season || '');

            // Handle feelings array
            if (userInputs.feelings && Array.isArray(userInputs.feelings)) {
                userInputs.feelings.forEach(feeling => {
                    params.append('feelings', feeling);
                });
            }

            // Add a flag to indicate this is pre-populated data
            params.set('prefilled', 'true');

            window.location.href = '/?' + params.toString();
        }

        // Start digital download process
        async function startDigitalDownload() {
            try {
                const completedImages = currentGallery.images.filter(img => img.status === 'completed');

                if (completedImages.length === 0) {
                    alert('No images are ready for download yet. Please wait for generation to complete.');
                    return;
                }

                const galleryId = getGalleryId();

                // TODO: Implement Stripe checkout for digital downloads
                alert(`Digital download coming soon!\n\nYou have ${completedImages.length} high-quality images ready for download.\n\nPrice: $${(completedImages.length * 4.99).toFixed(2)} total\n\nThis will include:\n• Watermark-free high-resolution versions\n• Multiple format options\n• Instant download access`);

            } catch (error) {
                console.error('Digital download error:', error);
                alert('Digital downloads are temporarily unavailable. Please try again later.');
            }
        }

        // Retry failed image generation
        async function retryImage(imageIndex) {
            try {
                const galleryId = getGalleryId();
                console.log(`🔄 Retrying image ${imageIndex} for gallery ${galleryId}`);

                // Update UI to show retrying
                const card = document.querySelector(`[data-index="${imageIndex}"]`);
                if (card) {
                    card.innerHTML = `
                        <div class="image-container">
                            <div class="generating-placeholder">
                                <div class="loading-spinner"></div>
                                <p>Retrying generation...</p>
                            </div>
                        </div>
                        <div class="image-info">
                            <div class="image-number">Artwork ${imageIndex}</div>
                            <div class="image-status">🔄 Retrying</div>
                        </div>
                    `;
                    card.className = 'image-card generating';
                }

                // Trigger retry webhook
                const response = await fetch('/api/webhook-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Webhook-Secret': 'webhook-secret-key'
                    },
                    body: JSON.stringify({
                        galleryId,
                        imageIndex,
                        enhancedPrompt: 'Retry generation',
                        aspectRatio: '1:1'
                    })
                });

                if (!response.ok) {
                    throw new Error('Retry request failed');
                }

                // Resume polling to track progress
                if (!isPolling) {
                    startPolling();
                }

            } catch (error) {
                console.error('Retry failed:', error);
                alert('Unable to retry image generation. Please refresh the page and try again.');
            }
        }

        // Add current gallery to localStorage collection when page loads
        function addCurrentGalleryToCollection() {
            const galleryId = getGalleryId();
            if (galleryId) {
                try {
                    const existing = JSON.parse(localStorage.getItem('omoideGalleries') || '[]');
                    if (!existing.includes(galleryId)) {
                        existing.push(galleryId);
                        localStorage.setItem('omoideGalleries', JSON.stringify(existing));
                        console.log(`📝 Added gallery ${galleryId} to collection. Total: ${existing.length}`);
                    }
                } catch (error) {
                    console.warn('Error saving gallery to localStorage:', error);
                }
            }
        }

        // Initialize gallery on page load
        document.addEventListener('DOMContentLoaded', () => {
            addCurrentGalleryToCollection();
            loadGallery();
        });
    </script>
</body>
</html>